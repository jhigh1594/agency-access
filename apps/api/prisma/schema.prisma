// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agencies
model Agency {
  id                   String                       @id @default(uuid())
  clerkUserId          String?                      @unique @map("clerk_user_id")
  name                 String
  email                String                       @unique
  subscriptionTier     String?                      @map("subscription_tier")
  settings             Json?
  
  // Notification settings
  notificationEmail    String?                      @map("notification_email")
  notificationEnabled  Boolean                      @default(true) @map("notification_enabled")

  createdAt            DateTime                     @default(now()) @map("created_at")
  updatedAt            DateTime                     @updatedAt @map("updated_at")

  members              AgencyMember[]
  accessRequests       AccessRequest[]
  connections          ClientConnection[]
  auditLogs            AuditLog[]
  platformConnections  AgencyPlatformConnection[]
  clients              Client[]
  templates            AccessRequestTemplate[]

  @@map("agencies")
}

// Agency team members
model AgencyMember {
  id         String    @id @default(uuid())
  agencyId   String    @map("agency_id")
  email      String
  role       String    // 'admin', 'member', 'viewer'
  invitedAt  DateTime  @default(now()) @map("invited_at")
  joinedAt   DateTime? @map("joined_at")

  agency     Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, email])
  @@map("agency_members")
}

// Agency platform connections (agency's own OAuth connections OR identity-only connections)
model AgencyPlatformConnection {
  id                  String    @id @default(uuid())
  agencyId            String    @map("agency_id")
  platform            String    // Platform identifier: group-level ('google', 'meta') or product-level ('google_ads', 'ga4', 'meta_ads', 'linkedin')

  // Connection mode: 'oauth' (token-based) or 'identity' (email/Business ID only)
  connectionMode      String    @default("oauth") @map("connection_mode") // 'oauth' | 'identity'

  // OAuth token storage (nullable for identity mode)
  secretId            String?   @map("secret_id") // Infisical secret name
  status              String    // 'active', 'expired', 'invalid', 'revoked'

  // OAuth metadata (nullable for identity mode)
  expiresAt           DateTime? @map("expires_at")
  lastRefreshedAt     DateTime? @map("last_refreshed_at")
  scope               String?   // Comma-separated scopes

  // Identity storage (for platform-native authorization flow)
  agencyEmail         String?   @map("agency_email") // For Google, LinkedIn
  businessId          String?   @map("business_id")  // For Meta Business Manager

  // Identity verification status
  verificationStatus  String?   @map("verification_status") // 'pending' | 'verified' | 'failed'
  lastVerifiedAt      DateTime? @map("last_verified_at")
  verificationError   String?   @db.Text @map("verification_error")

  // Platform-specific data (Business ID, Ad Account ID, etc.)
  metadata            Json?

  // Audit trail
  connectedBy         String    @map("connected_by") // Email of user who connected
  connectedAt         DateTime  @default(now()) @map("connected_at")
  revokedAt           DateTime? @map("revoked_at")
  revokedBy           String?   @map("revoked_by")

  agency              Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, platform])
  @@index([agencyId, status])
  @@index([agencyId, connectionMode])
  @@map("agency_platform_connections")
}

// Clients (reusable client profiles)
model Client {
  id              String          @id @default(uuid())
  agencyId        String          @map("agency_id")
  name            String          // Contact person name
  company         String          // Company name
  email           String
  website         String?
  language        String          @default("en") // 'en', 'es', 'nl', etc.
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  agency          Agency          @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  accessRequests  AccessRequest[]

  @@unique([agencyId, email])
  @@map("clients")
}

// Access Request Templates - agency-wide reusable templates
model AccessRequestTemplate {
  id              String   @id @default(uuid())
  agencyId        String   @map("agency_id")
  name            String
  description     String?  @db.Text
  platforms       Json     // Hierarchical format: { google: ['google_ads', 'ga4'] }
  intakeFields    Json     @map("intake_fields")
  branding        Json?
  isDefault       Boolean  @default(false) @map("is_default")
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, name])
  @@index([agencyId, isDefault])
  @@map("access_request_templates")
}

// Access requests created by agencies
model AccessRequest {
  id           String            @id @default(uuid())
  agencyId     String            @map("agency_id")
  clientId     String?           @map("client_id")
  clientName   String            @map("client_name")
  clientEmail  String            @map("client_email")
  platforms    Json              // Platform configuration with groups, products, access levels
  authModel    String            @default("client_authorization") @map("auth_model") // 'client_authorization' | 'delegated_access'
  status       String            // 'pending', 'partial', 'completed', 'expired', 'revoked'
  uniqueToken  String            @unique @map("unique_token")
  expiresAt    DateTime          @map("expires_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  intakeFields Json?             @map("intake_fields") // Custom form fields for client intake
  branding     Json?             // Custom branding (logo, colors, subdomain)
  authorizedAt DateTime?         @map("authorized_at") // When client completed authorization

  agency       Agency            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  client       Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  connection   ClientConnection?

  @@index([agencyId, status])
  @@map("access_requests")
}

// Client connections (after authorization)
model ClientConnection {
  id              String    @id @default(uuid())
  accessRequestId String    @unique @map("access_request_id")
  agencyId        String    @map("agency_id")
  clientEmail     String    @map("client_email")
  status          String    // 'active', 'revoked', 'expired'
  createdAt       DateTime  @default(now()) @map("created_at")
  revokedAt       DateTime? @map("revoked_at")
  revokedBy       String?   @map("revoked_by")

  // Granted assets from client (for partner access model)
  // Format: { adAccounts: [{id, name}], pages: [{id, name}], instagramAccounts: [{id, username}] }
  grantedAssets   Json?     @map("granted_assets")

  accessRequest   AccessRequest           @relation(fields: [accessRequestId], references: [id], onDelete: Cascade)
  agency          Agency                  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  authorizations  PlatformAuthorization[]

  @@index([agencyId, status])
  @@map("client_connections")
}

// Platform-specific authorizations
model PlatformAuthorization {
  id               String    @id @default(uuid())
  connectionId     String    @map("connection_id")
  platform         String    // Platform identifier: group-level ('google', 'meta') or product-level ('google_ads', 'ga4', 'meta_ads', 'linkedin')
  secretId         String    @map("secret_id") // AWS Secrets Manager ID
  expiresAt        DateTime? @map("expires_at")
  lastRefreshedAt  DateTime? @map("last_refreshed_at")
  status           String    // 'active', 'expired', 'invalid', 'revoked'
  metadata         Json?     // platform-specific data
  createdAt        DateTime  @default(now()) @map("created_at")
  
  connection       ClientConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, platform])
  @@index([connectionId, status])
  @@map("platform_authorizations")
}

// Audit logs for security tracking
model AuditLog {
  id                   BigInt   @id @default(autoincrement())
  agencyId             String?  @map("agency_id")
  userEmail            String?  @map("user_email")
  action               String   // 'token_viewed', 'access_granted', 'access_revoked', 'AGENCY_CONNECTED', 'AGENCY_DISCONNECTED', 'AGENCY_TOKEN_REFRESHED'
  resourceType         String?  @map("resource_type")
  resourceId           String?  @map("resource_id")
  agencyConnectionId   String?  @map("agency_connection_id")
  metadata             Json?
  ipAddress            String?  @map("ip_address")
  userAgent            String?  @map("user_agent")
  createdAt            DateTime @default(now()) @map("created_at")

  agency               Agency?  @relation(fields: [agencyId], references: [id])

  @@map("audit_logs")
}

// Authorization verification tracking (for platform-native identity flow)
model AuthorizationVerification {
  id                   String   @id @default(uuid())
  accessRequestId      String   @map("access_request_id")
  platform             String   // 'meta_ads', 'google_ads', 'ga4', etc.
  connectionId         String   @map("connection_id") // ClientConnection.id

  // Verification attempt tracking
  status               String   // 'pending' | 'verifying' | 'verified' | 'failed'
  attempts             Int      @default(0)
  lastAttemptAt        DateTime? @map("last_attempt_at")
  verifiedAt           DateTime? @map("verified_at")

  // Agency connection used for verification (must have OAuth token)
  agencyConnectionId   String   @map("agency_connection_id")

  // Verification results
  verifiedPermissions  Json?    @map("verified_permissions") // { granted: boolean, level: string, accounts: string[] }
  errorMessage         String?  @db.Text @map("error_message")

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@unique([connectionId, platform])
  @@index([accessRequestId, status])
  @@map("authorization_verifications")
}
